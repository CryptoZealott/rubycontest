#!/usr/bin/env ruby
require 'gli'
begin
require 'rubycon'
rescue LoadError
  exit 64
end
include GLI::App
include CommandLineReporter

program_desc 'CLI to manage your Source dedicated game servers.'
version Rubycon::VERSION

switch [:v, :verbose],  :negatable => false,
                        :desc => 'Prints debugging messages'

flag [:c, :config],     :default_value => File.join(ENV['HOME'],'.rubycon.yml'),
                        :desc => 'Path to configuration file'

desc 'adds a new server'
arg_name 'ALIAS', :optional
command :add do |c|
  c.flag  [:a, :address], :arg_name => 'HOSTNAME',
                          :desc => 'hostname or IP'

  c.flag [:p, :port],     :default_value => 27015,
                          :arg_name =>  'PORT',
                          :desc => 'Port',
                          :type => Integer

  c.flag [:r, :rcon],     :arg_name => 'RCON',
                          :desc => 'Rcon password'

  c.action do |global_options,options,args|
    exit_now!('ALIAS is required') if args.empty?
    exit_now!('HOSTNAME is required') unless options[:address]
    exit_now!('RCON is required') unless options[:rcon]

    s = Rubycon::Server.new(args.first, options[:address], options[:port], options[:rcon])
    $config.add_server s
  end
end

desc 'deletes an existing server'
arg_name 'ALIAS', :multiple
command :rm do |c|
  c. switch [:a, :all], :negatable => false,
                        :desc => 'Deletes all servers'

  c.action do |global_options,options,args|
    $config.delete_server args.first
  end
end

desc 'lists all servers'
command :list do |c|
  c.action do |global_options,options,args|
    alias_width = 11
    server_width = 25
    map_width = 18
    players_width = 8
    ping_width = 4

    table(:border => true) do
      row :header => true do
       column('Alias', :width => alias_width)
       column('Name', :width => server_width)
       column('Map', :align => 'right', :width => map_width)
       column('Players', :align => 'right', :width => players_width)
       column('Ping', :align => 'right', :width => ping_width)
     end
     $config.servers.each do |s|
      info = Rubycon::ServerInfo.new s
      row do
        column s.name.slice(0..alias_width - 2)
        column info.name.slice(0..server_width - 2)
        column info.map.slice(0..map_width - 2)
        column "#{info.players_count}/#{info.players_max}"
        column info.ping
      end
     end
    end
  end
end

desc 'starts a rcon session to a server'
arg_name 'ALIAS'
command :console do |c|
  c.action do |global_options,options,args|
    exit_now!('ALIAS is required') if args.empty?
    server = $config.find_by_name args.first
    puts 'Use CTRL+D to exit.'
    Rubycon::RconSession.start server
  end
end

pre do |global,command,options,args|
  $config = Rubycon::Config.load(global[:c])
end

on_error do |exception|
# puts exception.inspect
# puts exception.backtrace
  true
end

exit run(ARGV)